# 1 文件格式

MP3文件格式四部分，按顺序排列如下：

ID3V2 ------ 包含了作者，作曲，专辑等信息，长度不固定，扩展了ID3V1的信息量

Frame ------ 音频帧序列

APEV2 ------ 包含了作者，作曲，专辑等信息，长度不固定，扩展了ID3V1的信息量

ID3V1 ------ 包含了作者，作曲，专辑等信息，长度为128BYTE

## 1.1 ID3 V1

ID3 V1内容按顺序排列如下：
 ```
 --------------------|------------------
 名称                |      位置(byte)
 --------------------|------------------
 标签标志'TAG'       |      0~2
 --------------------|------------------
 标题                |      3~32
 --------------------|------------------
 艺术家              |    33~62
 --------------------|------------------
 专辑                |    63~92
 --------------------|------------------
 年代                |    93~96
 --------------------|------------------
 注释                |    97~126
 --------------------|------------------
 流派                |    127
 --------------------|------------------
 ```
 //note:因ID3 V1未规定填充内容的格式，在某些情况下会引起问题。如台湾常常采用big5编码，如果当成ASCII码处理就会出错。

## 1.2 ID3 V2
```
 --------------------|------------------
 Tag Header          |  10 bytes
 --------------------|------------------
 Tag Frame 序列      |  长度不定
 --------------------|------------------
```

### 1.2.1 Tag Header格式:
```
  ------------------|-----------------|--------------------------------
  名称              |  字节数         |  描述
  ------------------|-----------------|--------------------------------
  标识              |  3 bytes        | 必须为“ID3”
  ------------------|-----------------|--------------------------------
  Version           |  1 byte         | ID3V2.3 就记录3
  ------------------|-----------------|--------------------------------
  Revision          |  1 byte         | 记录为0
  ------------------|-----------------|--------------------------------
  Flag              |  1 byte         | 标志是否存在extended Header等
  ------------------|-----------------|--------------------------------
  Size              |  4 bytes        | 标签大小，包括标签头的10 个字节
  ------------------|-----------------|--------------------------------
```
### 1.2.2 Tag Frame格式
  Tag Frame Header(10 bytes)
```
   ----------------|-----------------|--------------------------------
   名称            |  字节数         |  描述
   ----------------|-----------------|--------------------------------
   Frame ID        |  4 bytes        | 四个字符标识一个帧，说明其内容
   ----------------|-----------------|--------------------------------
   Size            |  4 bytes        | 帧内容的大小，不包括帧头
   ----------------|-----------------|--------------------------------
   Flag            |  2 bytes        | 表明内容是否存在压缩、加密等
   ----------------|-----------------|--------------------------------
  Frame Header
  ...
  ...

  Frame ID对照表如下：
   -----------|---------------------------------------------------
   标识       |  描述
   -----------|---------------------------------------------------
   AENC       |  Audio encryption 
   -----------|---------------------------------------------------
   APIC       |  Attached picture
   -----------|---------------------------------------------------
   COMM       |  Comments 
   -----------|---------------------------------------------------
   COMR       |  Commercial frame 
   -----------|---------------------------------------------------
   ENCR       |  Encryption method registration 
   -----------|---------------------------------------------------
   EQUA       |  Equalization 
   -----------|---------------------------------------------------
   ETCO       |  Event timing codes 
   -----------|---------------------------------------------------
   GEOB       |  General encapsulated object 
   -----------|---------------------------------------------------
   GRID       |  Group identification registration
   -----------|-------------------------------- -------------------
   IPLS       |  Involved people list 
   -----------|---------------------------------------------------
   LINK       |  Linked information 
   -----------|---------------------------------------------------
   MCDI       |  Music CD identifier 
   -----------|---------------------------------------------------
   MLLT       |  MPEG location lookup table 
   -----------|---------------------------------------------------
   OWNE       |  Ownership frame 
   -----------|---------------------------------------------------
   PRIV       |  Private frame 
   -----------|---------------------------------------------------
   PCNT       |  Play counter 
   -----------|---------------------------------------------------
   POPM       |  Popularimeter 
   -----------|---------------------------------------------------
   POSS       |  Position synchronisation frame 
   -----------|---------------------------------------------------
   RBUF       |  Recommended buffer size 
   -----------|---------------------------------------------------
   RVAD       |  Relative volume adjustment 
   -----------|---------------------------------------------------
   RVRB       |  Reverb 
   -----------|---------------------------------------------------
   SYLT       |  Synchronized lyric/text 
   -----------|---------------------------------------------------
   SYTC       |  Synchronized tempo codes 
   -----------|---------------------------------------------------
   TALB       |  Album/Movie/Show title 
   -----------|---------------------------------------------------
   TBPM       |  BPM (beats per minute) 
   -----------|---------------------------------------------------
   TCOM       |  Composer 
   -----------|---------------------------------------------------
   TCON       |  Content type 
   -----------|---------------------------------------------------
   TCOP       |  Copyright message 
   -----------|---------------------------------------------------
   TDAT       |  Date 
   -----------|---------------------------------------------------
   TDLY       |  Playlist delay 
   -----------|---------------------------------------------------
   TENC       |  Encoded by 
   -----------|---------------------------------------------------
   TEXT       |  Lyricist/Text writer 
   -----------|---------------------------------------------------
   TFLT       |  File type 
   -----------|---------------------------------------------------
   TIME       |  Time 
   -----------|---------------------------------------------------
   TIT1       |  Content group description 
   -----------|---------------------------------------------------
   TIT2       |  Title/songname/content description 
   -----------|---------------------------------------------------
   TIT3       |  Subtitle/Description refinement
   -----------|---------------------------------------------------
   TKEY       |  Initial key 
   -----------|---------------------------------------------------
   TLAN       |  Language(s) 
   -----------|---------------------------------------------------
   TLEN       |  Length 
   -----------|---------------------------------------------------
   TMED       |  Media type 
   -----------|---------------------------------------------------
   TOAL       |  Original album/movie/show title 
   -----------|---------------------------------------------------
   TOFN       |  Original filename 
   -----------|---------------------------------------------------
   TOLY       |  Original lyricist(s)/text writer(s) 
   -----------|---------------------------------------------------
   TOPE       |  Original artist(s)/performer(s) 
   -----------|---------------------------------------------------
   TORY       |  Original release year 
   -----------|---------------------------------------------------
   TOWN       |  File owner/licensee 
   -----------|---------------------------------------------------
   TPE1       |  Lead performer(s)/Soloist(s) 
   -----------|---------------------------------------------------
   TPE2       |  Band/orchestra/accompaniment 
   -----------|---------------------------------------------------
   TPE3       |  Conductor/performer refinement 
   -----------|---------------------------------------------------
   TPE4       |  Interpreted, remixed, or otherwise modified by 
   -----------|---------------------------------------------------
   TPOS       |  Part of a set 
   -----------|---------------------------------------------------
   TPUB       |  Publisher 
   -----------|---------------------------------------------------
   TRCK       |  Track number/Position in set 
   -----------|---------------------------------------------------
   TRDA       |  Recording dates 
   -----------|---------------------------------------------------
   TRSN       |  Internet radio station name 
   -----------|---------------------------------------------------
   TRSO       |  Internet radio station owner 
   -----------|---------------------------------------------------
   TSIZ       |  Size 
   -----------|---------------------------------------------------
   TSRC       |  ISRC (international standard recording code) 
   -----------|---------------------------------------------------
   TSSE       |  Software/Hardware and settings used for encoding
   -----------|--------------------------------------------------- 
   TYER       |  Year 
   -----------|---------------------------------------------------
   TXXX       |  User defined text information frame 
   -----------|---------------------------------------------------
   UFID       |  Unique file identifier 
   -----------|---------------------------------------------------
   USER       |  Terms of use 
   -----------|---------------------------------------------------
   USLT       |  Unsychronized lyric/text transcription 
   -----------|---------------------------------------------------
   WCOM       |  Commercial information 
   -----------|---------------------------------------------------
   WCOP       |  Copyright/Legal information 
   -----------|---------------------------------------------------
   WOAF       |  Official audio file webpage 
   -----------|---------------------------------------------------
   WOAR       |  Official artist/performer webpage 
   -----------|---------------------------------------------------
   WOAS       |  Official audio source webpage 
   -----------|---------------------------------------------------
   WORS       |  Official internet radio station homepage 
   -----------|---------------------------------------------------
   WPAY       |  Payment 
   -----------|---------------------------------------------------
   WPUB       |  Publishers official webpage 
   -----------|---------------------------------------------------
   WXXX       |  User defined URL link frame
   -----------|---------------------------------------------------
```
## 1.3 APE V2
```
 ------------------|-----------------
   名称            |  字节数    
 ------------------|-----------------
 APE Tags Header   |  32 bytes
 ------------------|-----------------
 APE Tag Item 1    |  10 bytes
 ------------------|-----------------
 APE Tag Item 2    |  10 bytes
 ------------------|-----------------
 …                 |  10 bytes
 ------------------|-----------------
 APE Tag Item n-1  |  10 bytes
 ------------------|-----------------
 APE Tag Item n    |  10 bytes
 ------------------|-----------------
 APE Tags Footer   |  32 bytes
 ------------------|-----------------
```
 APE tag items should be sorted ascending by size. When streaming, parts of the APE tags can be dropped to reduce danger of drop outs between titles. This is not a must , but strongly recommended. Actually the items should be sorted by importance/byte, but this is not feasible. Only break this rule if you add less important small items and you don't want to rewrite the whole tag. An APE tag at the end of a file (strongly recommended) must have at least a footer, an APE tag in the beginning of a file (strongly unrecommended) must have at least a header. When located at the end of an MP3 file, an APE tag should be placed after the the last frame, just before the ID3v1 tag (if any).

## 1.4 Frame
```
 ------------------|-----------------------------
   名称            |  字节数    
 ------------------|-----------------------------
 Frame Header      | 4 bytes
 ------------------|-----------------------------
 Side Information  | 单声道17bytes，双声道32bytes
 ------------------|-----------------------------
 Frame Data        | 不定长
 ------------------|-----------------------------
```
### 1.4.1 Frame Header
```
 ----|---------|--------------------------------------------------------------------------------------------
 11  |  31~21  |  帧同步（所有位置1）
 ----|---------|--------------------------------------------------------------------------------------------
 2   |  20~19  |  MPEG 音频版本ID
     |         |   00 - MPEG 2.5
     |         |   01 - 保留
     |         |   10 - MPEG 2(ISO/IEC 13818-3)
     |         |   11 - MPEG 1(ISO/IEC 11172-3)
     |         |  注：MPEG 2.5不是官方标准。帧骰第20个bit用来表示2.5版本。不支持改版本的应用程序一般认为
     |         |  该bit位置位为帧同步位，也就是说帧同步的长度为12而不是这里规定的11，这样这个位置也就变成
     |         |  了1位（第19位）。推荐使用该表的方法，因为这样允许你可以区分三个版本以获得最高兼容性。
 ----|---------|--------------------------------------------------------------------------------------------  
 2   |  18~17  |  Layer 描述
     |         |   00 - 保留
     |         |   01 - Layer III
     |         |   10 - Layer II
     |         |   11 - Layer I
 ----|---------|--------------------------------------------------------------------------------------------  
 1   |  16     |  校验位
     |         |   0 - 紧跟帧头后有16位，即2个字节用作CRC校验
     |         |   1 - 没有校验
 ----|---------|--------------------------------------------------------------------------------------------   
 4   |  15~12  |  位率索引
     |         |   --------|---------------------------------|---------------------------
     |         |   索引值  |  MPEG 1                         |  MPEG 2,2.5(LSF)
     |         |           |---------|-----------|-----------|---------|-----------------
     |         |           | Layer I | Layer II  | Layer III | Layer I | Layer II & III
     |         |   --------|---------|-----------|-----------|---------|-----------------     
     |         |   0000    | Free    | Free      | Free      | Free    | Free
     |         |   --------|---------|-----------|-----------|---------|-----------------
     |         |   0001    | 32      | 32        | 32        | 32      | 8
     |         |   --------|---------|-----------|-----------|---------|-----------------
     |         |   0010    | 64      | 48        | 40        | 48      | 16
     |         |   --------|---------|-----------|-----------|---------|-----------------
     |         |   0011    | 96      | 56        | 48        | 56      | 24
     |         |   --------|---------|-----------|-----------|---------|-----------------
     |         |   0100    | 128     | 64        | 56        | 64      | 32
     |         |   --------|---------|-----------|-----------|---------|-----------------
     |         |   0101    | 160     | 80        | 64        | 80      | 40
     |         |   --------|---------|-----------|-----------|---------|-----------------
     |         |   0110    | 192     | 96        | 80        | 96      | 48
     |         |   --------|---------|-----------|-----------|---------|-----------------
     |         |   0111    | 224     | 112       | 96        | 112     | 56
     |         |   --------|---------|-----------|-----------|---------|-----------------
     |         |   1000    | 256     | 128       | 112       | 128     | 64
     |         |   --------|---------|-----------|-----------|---------|-----------------
     |         |   1001    | 288     | 160       | 128       | 144     | 80
     |         |   --------|---------|-----------|-----------|---------|-----------------
     |         |   1010    | 320     | 192       | 160       | 160     | 96
     |         |   --------|---------|-----------|-----------|---------|-----------------
     |         |   1011    | 352     | 224       | 192       | 176     | 112
     |         |   --------|---------|-----------|-----------|---------|-----------------
     |         |   1100    | 384     | 256       | 224       | 192     | 128
     |         |   --------|---------|-----------|-----------|---------|-----------------
     |         |   1101    | 416     | 320       | 256       | 224     | 144
     |         |   --------|---------|-----------|-----------|---------|-----------------
     |         |   1110    | 448     | 384       | 320       | 256     | 160
     |         |   --------|---------|-----------|-----------|---------|-----------------
     |         |   1111    | Bad     | Bad       | Bad       | Bad     | Bad
     |         |   --------|---------|-----------|-----------|---------|-----------------
 ----|---------|--------------------------------------------------------------------------------------------   
 2   | 11~10   |  采样频率（单位：Hz）
     |         |  ------|---------|---------|----------
     |         |  bits  | MPEG 1  | MPEG 2  | MPEG 2.5
     |         |  ------|---------|---------|----------
     |         |  00    | 44100   | 22050   | 11025
     |         |  ------|---------|---------|----------
     |         |  01    | 48000   | 24000   | 12000
     |         |  ------|---------|---------|----------
     |         |  10    | 32000   | 16000   | 8000
     |         |  ------|---------|---------|----------
     |         |  11    | 保留    | 保留    | 保留
     |         |  ------|---------|---------|----------
 ----|---------|--------------------------------------------------------------------------------------------   
 1   | 9       |  填充位
     |         |   0 - 没有填充
     |         |   1 - 填充了一个额外的空位
     |         |   填充用来达到正确的比特率。例如：128k 44.1kHz LayerII使用了很多418bit或417bit长度的帧
     |         |   来达到正确的128k比特率。LayerI的空位有32bit长，LayerII和LayerIII的空位有8bit长。
 ----|---------|--------------------------------------------------------------------------------------------
 1   | 8       |  私有bit，可以用来做特殊应用。例如可以用来触发应用程序的特殊事件。
 ----|---------|--------------------------------------------------------------------------------------------
 2   | 7~6     |  声道
     |         |   00 - 立体声
     |         |   01 - 联合立体声
     |         |   10 - 双声道（立体声）
     |         |   11 - 单声道（单声）
     |         |  注：双声道文件由两个独立的单声道组成。每一个声道使用整个文件一半的位率。大多数的解码器把
     |         |  它当做立体声来输出，但是它并不总是这种情况。个人理解两个声道的信息是完全相同的，并不能把
     |         |  它当做立体声看待。 
 ----|---------|--------------------------------------------------------------------------------------------
 2   | 5~4     |  扩展模式（仅在联合立体声时有效）
     |         |  扩展模式用来连接对立体声效果无用的信息，来减少所需的资源。这两个位在联合立体声模式下有编
     |         |  码器动态指定。
     |         |  完整的MPEG文件的频率序列分成有32个子带。在LayerI和LayerII中这两个位确定强度立体声应用的频
     |         |  带。LayerIII中这两个位确定应用了哪一种联合立体声（M/S stereo或者Intensity stereo）频带由解
     |         |  压算法决定。
     |         |  ----|---------------|-------------------------------
     |         |  值  | LayerI & II   | LayerIII
     |         |      |               |-------------|-----------------
     |         |      |               | M/S stereo  | Intensity stereo
     |         |  ----|---------------|-------------|-----------------  
     |         |  00  | bands 4 to 31 | off         | off
     |         |  ----|---------------|-------------|-----------------
     |         |  01  | bands 8 to 31 | off         | on
     |         |  ----|---------------|-------------|-----------------
     |         |  10  | bands 12 to 31| on          | off
     |         |  ----|---------------|-------------|-----------------
     |         |  11  | bands 16 to 31| on          | on       
     |         |  ----|---------------|-------------|----------------- 
 ----|---------|--------------------------------------------------------------------------------------------
 1   | 3       |  版权
     |         |   0 - 无版权
     |         |   1 - 有版权
 ----|---------|--------------------------------------------------------------------------------------------
 1   | 2       |  原创
     |         |   0 - 原创拷贝
     |         |   1 - 原创 
 ----|---------|--------------------------------------------------------------------------------------------
 2   | 1~0     |  强调
     |         |   00 - 无
     |         |   01 - 50/15 ms
     |         |   10 - 保留
     |         |   11 - CCIT J.17
 ----|---------|--------------------------------------------------------------------------------------------   
```
### 1.4.2 Side information
```
 ----------------------------------|-----------------------------------------------------------------
      比特数/bit                   |            描述    
 --------------|-------------------|
 单声道 ch=0   | 双声道 ch=0,1     |
 --------------|-------------------|-----------------------------------------------------------------
 9             | 9                 |  主数据开始指针(main_data_begin)
 --------------|-------------------|-----------------------------------------------------------------
 5             | 3                 |  私有位(private_bits)
 --------------|-------------------|-----------------------------------------------------------------
 4*1           | 2*4*1             |  两个粒度共有选择信息(scfsi[ch][scfsi_band])
 --------------|-------------------|-----------------------------------------------------------------
                                   |  粒度组的边信息，即gr=0
 --------------|-------------------|-----------------------------------------------------------------
 12            | 2*12              |   主数据位数(part2-3-length[gr][ch]) 
 --------------|-------------------|-----------------------------------------------------------------
 9             | 2x9               |   大值(big_values[gr][ch])
 --------------|-------------------|-----------------------------------------------------------------
 8             | 2*8               |   全局增益(global_gain[gr][ch])
 --------------|-------------------|-----------------------------------------------------------------
 4             | 2*4               |   比例因子压缩(scalefac_compress[gr][ch])
 --------------|-------------------|-----------------------------------------------------------------
 1             | 2*1               |   窗切换标志(window_switching_flag[gr][ch])
 --------------|-------------------|-----------------------------------------------------------------
                                   |   窗切换标志为"1"时
 --------------|-------------------|-----------------------------------------------------------------
 2             | 2*2               |    块类型(block_type[gr][ch])
 --------------|-------------------|-----------------------------------------------------------------
 1             | 2*1               |    混合块标志(mixed_block_flag)
 --------------|-------------------|-----------------------------------------------------------------
 2*5           | 2*2*5             |    表选择(table_select[gr][ch][region]) region:0,1
 --------------|-------------------|-----------------------------------------------------------------
 3*3           | 2*3*3             |    子块增益(subblock_gain[gr][ch][window]) window:0,1,2
 --------------|-------------------|-----------------------------------------------------------------
                                   |   窗切换标志为"0"时 
 --------------|-------------------|-----------------------------------------------------------------
 3*5           | 2*3*5             |    表选择(table_select[gr][ch][region]) region:0,1,2
 --------------|-------------------|-----------------------------------------------------------------
 4             | 2*4               |    区域0 --- 计数(region_0_count[gr][ch])
 --------------|-------------------|-----------------------------------------------------------------
 3             | 2*3               |    区域1 --- 计数(region_1_count[gr][ch])
 --------------|-------------------|-----------------------------------------------------------------
 1             | 2*1               |   预标志(preflag[gr][ch])
 --------------|-------------------|-----------------------------------------------------------------
 1             | 2*1               |   比例因子—缩放(scalefac_scale[gr][ch]) 
 --------------|-------------------|-----------------------------------------------------------------
 1             | 2*1               |   计数1表选择(count_1_table_select[gr][ch])
 --------------|-------------------|-----------------------------------------------------------------
 同粒度组1     | 同粒度组1         |   粒度组2的边信息，即gr=1
 --------------|-------------------|-----------------------------------------------------------------
 17字节        | 32字节            |   总占用的字节数
 --------------|-------------------|-----------------------------------------------------------------
 ```
 main_data_begin：表示一帧数据main_data开始的位置。表示main data相对于该帧同步头的负偏移。这里涉及到bit reservior技术:即把当前帧未使用完的bit数，留给后面需要的帧使用，这就导致每一帧的main data开始的位置，可能在它的Header和side information之前。

 Private_bits：留作私用。

 Scfsi：表明两个granule是否使用相同的缩放因子。

 scalefac_compress：被编码的缩放因子所占的比特数。

 Part_2_3_length：表示main data中scalefactor和Huffman数据所占的比特数。

 Global_gain：全局量化步长。

 window_switching_flag、 block_bype和mixed_block_type：
  当window_switching_flag未置位时，block_type为0；
  当其置位时， block_type由mixed_block_type[gr][ch]指定，如下所示：
   0 - reserved
   1 - start block
   2 - 3 short windows
   3 - end block
  当block_type为0、1、3时，为长块；为2时，为短块。mixed_block_flag[gr][ch]为1时，为混合块。

 Table_select、Big_value、count1_table_select、Region0_count和region1_count：参考Huffman码表选择。

 subblock_gain：短窗量化时所用的增益偏移量。

 preflag和scalefac_scale：反量化时用到的变量。 

# 2 编码原理及流程
```
                  |---------------------|             |-------------------| 
    Digital       | 32-Chennel Polyphase|   |-----|   |Bit Allocation Loop|
    Audio Signal  | Analysis Filterbank |-->|MDCT |-->|  Quantization     |
----------------->|---------------------|   |-----|   |  Huffman Coding   |-->|-----------|
    |                                           ^     |-------------------|   |           |  Coded
    |                                  window   |     ^          |            | Bitstream |  Audio Data  
    |                                  switching| SM R|          v            | Formatting|------------->
    |           |---|           |---------------|     |   |---------------|   |           |
    ----------->|FFT|---------->|Psychoacaoustic|------   |  Coding of    |-->|-----------|
                |---|           |  Model II     |         |Side-Infomation|  
                                |---------------|         |---------------|
```
 以单声道而言，MP3一帧包含1152个声音取样，一帧分为2节（granule）。
  mp3编码时，首先将原始的PCM数据送入滤波器组，分成32个等频宽的子频带，
  然后再通过MDCT（modified discrete coding transform），将每个子带，转换成18个次频带。
  然后根据第二声学模型提供的SMR（signal-to-mask ratio），对每一个子频带信号，做位元分配和编码。

## Step 1：prediction

  根据第二声学模型做预测，预测结果得到的SMR会作为位元分配的依据。
  第二声学模型中几个重要依据如下：
   静音阈值曲线、时域掩蔽效应、频域掩蔽效应、临界频带。

## Step 2：子带分离(Analysis Subband Filter)

  将原始的PCM数据送入滤波器组，分成32个等频宽的子频带。

## Step 3：MDCT 
``` 
                                          Subband output
PCM audio input |-----| P0(n) /------\
--------------->|H0(n)|-------|  |32 |--> S0(n)={...,P0(0),P0(32),P0(64),...}
      |         |-----|       |  V   |
      |                       \------/
      |    
      |         |-----| P1(n) /------\
      |-------->|H1(n)|-------|  |32 |--> S1(n)={...,P1(0),P1(32),P1(64),...}
      |         |-----|       |  V   |
      |                       \------/        
      |
      |
      |
      |         |------|P0(n)  /------\
      --------->|H31(n)|-------|  |32 |--> S31(n)={...,P31(0),P31(32),P31(64),...}
                |------|       |  V   |
                               \------/                
```
  MDCT滤波器将32个子带中每一个子带的的信号在频域上进一步划分，
  长块进行18点（18个频域采样点）的MDCT变换，
  短块进行6点（6个频域采样点）的MDCT变换，以窗为单位分3次进行。
  MDCT包括三部分：MDCT窗框、MDCT、长窗假象处理。

### (a)MDCT加窗

  4种窗及使用情形如下：
   （图略，画不出来 <-><->!!）
  窗框的选择依据第二声学模型，规则通常如下：
   子频带音频讯号稳定时，采用长窗来提供最细的频谱解析度；
   子频带变动较大时，采用短窗提供较大的时域解析度。
   决定好窗框以后，就可以以窗框为单位进行MDCT运算。
   如果是长窗，需要针对混跌做假象处理。

### (b)MDCT

  作用：将时域信号转换成频域信号
  In the case of long blocks ( block_type 0,1,3 ) there are 36 coefficents in the time domain and 18 in the frequency domain.
  In the case of short blocks (block_type 2 ) there are 3 transformations with short length. This leads to 12 coefficents in the time and 6 in the frequency domain.

### (c)长窗假象处理(混叠消除)

  什么是长窗假象：
   使用长窗时，频谱上可见邻近的子频带间有明显的重叠现象，处于重叠区间的讯号将会同时影响两个子频带。
  假象处理的方式：将处在相对应位置的频线之能量做一定比例的增减,蝶形运算。
  附：Step2和Step3的综合图为：
```
                       Subband0 |-----------|       |----|--------->|---------|-------> 
            |-------- |-------->|MDCT Window|------>|MDCT|--------->|         |-------> 
            |Analysis |         |-----------|<---   |----|<-- :     |Alias    |  :
            |         |                         |           |       |         |
  PCM audio |         |Subband1 |-----------|   |   |----|--|------>|Reduction|-------> 
   input    |         |-------->|MDCT Window|---|-->|MDCT|--|------>|         |-------> 
  --------->| Subband |         |-----------|<--|   |----|<-| :     |(only    |  :
            |         |               :         |     :     |       |for      |
            |         |               :         |     :     |       |long     |
            |         |Subband31|-----------|   |   |----|--|------>|blocks)  |-------> 
            | Filter  |-------->|MDCT Window|---|-->|MDCT|--|------>|         |-------> 
            |---------|         |-----------|<--|   |----|<-| :     |---------|  :
                                                |           |    
                                                |           |
            |---------------------------|       | |--------------|
            |window select              |       | | long or short|
            |  normal,start,short,stop  |-------- | block control|
            |---------------------------|         |--------------|
```
## Step 4： Joint Stereo(联合立体声)

  编码依据：2个声道存在相干性，方法有：
  Intensity Stereo(IS):
   Human hearing is predominantly less acute at perceiving the direction of certain audio frequencies
  Mid/Side (M/S) stereo ：
   The mid channel is L + R. The side channel is L − R

## Step 5：位元分配(bit allocation)

  根据第二声学模型的预测结果，进行位元分配；位元分配是一个反复调整的过程。

## Step 6：量化

  以缩放因子频带为单位，进行量化。缩放因子频带内使用相同的缩放因子。
  mp3中一帧数据含有1152个PCM数据，分成2节（granual）。
  每节含有576个PCM数据，这576个值在不同的节类型有不同的定义。如下所述：
### （a）该节为长块：这576个值代表576条频率线上的值，是时域上的576个pcm值经过时频变换的结果。
  这576条频率线从低到高分成32个子带，每个子带含18条频率线。
  同时，也将这576个数据分成若干个缩放因子带，每个缩放因子带共用一个缩放因子。
  长块的缩放因子带在44kHz按如下表格划分，其中，418-575不属于任何一个缩放因子带，使用系统提供的默认缩放因子：
```  
  |-----------------|---------------|----------------|------------|
  |scalefactor band | width of band | index of start |index of end|
  |-----------------|---------------|----------------|------------| 
  |    0            |    4          |    0           |   3        |
  |-----------------|---------------|----------------|------------|
  |    1            |    4          |    4           |   7        |
  |-----------------|---------------|----------------|------------|
  |    2            |    4          |    8           |   11       |
  |-----------------|---------------|----------------|------------|
  |    3            |    4          |    12          |   15       |
  |-----------------|---------------|----------------|------------|
  |    4            |    4          |    16          |   19       |
  |-----------------|---------------|----------------|------------|
  |    5            |    4          |    20          |   23       |
  |-----------------|---------------|----------------|------------|
  |    6            |    6          |    24          |   29       |
  |-----------------|---------------|----------------|------------|
  |    7            |    6          |    30          |   35       |
  |-----------------|---------------|----------------|------------|
  |    8            |    8          |    36          |   43       |
  |-----------------|---------------|----------------|------------|
  |    9            |    8          |    44          |   51       |
  |-----------------|---------------|----------------|------------|
  |    10           |    10         |    52          |   61       |
  |-----------------|---------------|----------------|------------|
  |    11           |    12         |    62          |   73       |
  |-----------------|---------------|----------------|------------|
  |    12           |    16         |    74          |   89       |
  |-----------------|---------------|----------------|------------|
  |    13           |    20         |    90          |   109      |
  |-----------------|---------------|----------------|------------|
  |    14           |    24         |    110         |   133      |
  |-----------------|---------------|----------------|------------|
  |    15           |    28         |    134         |   161      |
  |-----------------|---------------|----------------|------------|
  |    16           |    34         |    162         |   195      |
  |-----------------|---------------|----------------|------------|
  |    17           |    42         |    196         |   237      |
  |-----------------|---------------|----------------|------------|
  |    18           |    50         |    238         |   287      |
  |-----------------|---------------|----------------|------------|
  |    19           |    54         |    288         |   341      |
  |-----------------|---------------|----------------|------------|
  |    20           |    76         |    342         |   417      |
  |-----------------|---------------|----------------|------------|
```
### （b）该节为短块：这576个值代表192条频率线的值，192条频率线分32个子带，每条子带包括6条频率线。
  每条频率线有3个值，分别属于3个窗 （windows_0,windows_1,windows_2）。
  192条频率线也被分成若干缩放因子带，在44.1kHz时划分如下图,其中，136-191使用默认缩放因子。
```  
  |-----------------|---------------|----------------|------------|
  |scalefactor band | width of band | index of start |index of end|
  |-----------------|---------------|----------------|------------| 
  |    0            |    4          |    0           |   3        |
  |-----------------|---------------|----------------|------------|
  |    1            |    4          |    4           |   7        |
  |-----------------|---------------|----------------|------------|
  |    2            |    4          |    8           |   11       |
  |-----------------|---------------|----------------|------------|
  |    3            |    4          |    12          |   15       |
  |-----------------|---------------|----------------|------------|
  |    4            |    6          |    16          |   21       |
  |-----------------|---------------|----------------|------------|
  |    5            |    8          |    22          |   29       |
  |-----------------|---------------|----------------|------------|
  |    6            |    10         |    30          |   39       |
  |-----------------|---------------|----------------|------------|
  |    7            |    12         |    40          |   51       |
  |-----------------|---------------|----------------|------------|
  |    8            |    14         |    52          |   65       |
  |-----------------|---------------|----------------|------------|
  |    9            |    18         |    66          |   83       |
  |-----------------|---------------|----------------|------------|
  |    10           |    22         |    84          |   105      |
  |-----------------|---------------|----------------|------------|
  |    11           |    30         |    106         |   135      |
  |-----------------|---------------|----------------|------------|
```
  这576个值得排列顺序为：
   先是按缩放因子带从低到高排列；
   缩放因子带内，按windows_0,windows_2,windows_3排列；
   每一个window中，频率线从低到高排列。

### （c）该节为混合块，解出来的值分2个部分：
  第一部分（前36个值）是长块，代表36条频率线；
  第二部分（后540个值）为短块，代表180个频率线。
  2部分的排列方式分别于长块和短块相同。
  综上，有：
```  
   长块   Sfb0 Sfb1 Sfb2 ...... Sfb20

   短块   Sfb0_w0 Sfb0_w1 Sfb0_w2 Sfb1_w0 Sfb1_w1 Sfb1_w2 ...... Sfb11_w0 Sfb11_w1 Sfb11_w2

   混合块  Sfb0 Sfb1 ...... Sfb7 Sfb3_w0 Sfb3_w1 Sfb3_w2 ...... Sfb11_w0 Sfb11_w1 Sfb11_w2
       |------长块部分------|----------------------短块部分---------------------------|
```
  附： 缩放因子
  缩放因子带在逆量化时，共用的缩放因子被编码于main_data中。
  欲解码缩放因子，首先得知道缩放因子所占的比特数，
  在side information的```scale_compress[gr][ch]```提供这样的信息，所用的bit数通过查如下表才能得到。
  slen 1和slen 2针对那些缩放因子带，由块类型决定。
```  
  |---------------|-------|-------|
  |scale_compress | slen 1| slen 2|
  |---------------|-------|-------|
  |    0          |  0    |  0    |
  |---------------|-------|-------|
  |    1          |  0    |  1    |
  |---------------|-------|-------|
  |    2          |  0    |  2    |
  |---------------|-------|-------|
  |    3          |  0    |  3    |
  |---------------|-------|-------|
  |    4          |  3    |  0    |
  |---------------|-------|-------|
  |    5          |  1    |  1    |
  |---------------|-------|-------|
  |    6          |  1    |  2    |
  |---------------|-------|-------|
  |    7          |  1    |  3    |
  |---------------|-------|-------|
  |    8          |  2    |  1    |
  |---------------|-------|-------|
  |    9          |  2    |  2    |
  |---------------|-------|-------|
  |    10         |  2    |  3    |
  |---------------|-------|-------|
  |    11         |  3    |  1    |
  |---------------|-------|-------|
  |    12         |  3    |  2    |
  |---------------|-------|-------|
  |    13         |  3    |  3    |
  |---------------|-------|-------|
  |    14         |  4    |  2    |
  |---------------|-------|-------|
  |    15         |  4    |  3    |
  |---------------|-------|-------|
```
## Step 7:Huffman编码

### (a)Huffman码表选择

  当从一个缩放因子频带过渡到另一个缩放因子频带时，Huffman码表可能发生改变；
  需要进行编码的576个值分为大值区、小值区、零值区：
```
   xxxxxxxxxxxxx----------------------00000000000000000000000000000
   |           |                      |                           |
   1       bigvalues*2            bigvalues*2+count1*4           iblen

   The values 000 are all zero.
   The values --- are -1,0 or +1.Their number is a multiple of 4.
   The values xxx are not bound
   Iblen is 576.
```
  不同的区域使用不同的Huffman表编码。
  大值区每2个值一起编码，小值区每4个值一起编码，零值区无需编码。
  大值区以缩放因子频带为单位，分为3个region。
  每个region使用不同的Huffman表。
  一共有32个Huffman表供选择。

### (b)huffman编码(略)

  注：大值区的Huffman表有一个参数linbits，用来指定Huffman表是否能用来编码大于15的数。

## Step 8:生成帧

  加上Frame Header和Side Information，生成帧。

# 3 解码流程
```
                                |---------|
                                |Huffman  |   |--------------|    |----------|    |---------|
    MP3     |---------------|-->|decoding |-->|Requantization|--->|Reordering|--->|Stereo   |------
 bitstream  | Preprocessing |   |---------|   |--------------|    |----------|    |decoding |     |
----------->|               |       ^                ^                            |---------|---- |
            |---------------|-------|--------------  |                                          | |
                                |   |             |  |                                          | |
                                v   |             v  |                                          | |
                          |--------------| |--------------|                                     | |
                          |Huffman tables| | Scale factors|                                     | |
                          |--------------| |--------------|                                     | |
                                                                                                | |
      ------------------------------------------------------------------------------------------- |
      | -------------------------------------------------------------------------------------------
      | |   |---------|     |-----|     |---------|     |-----------|
      | --->|  Alias  |---->|IMDCT|---->|Frequency|---->|Synthesis  |------>  Right PCM
      |     |reduction|     |-----|     |inversion|     |Filter bank|         channel
      |     |---------|                 |---------|     |-----------|
      |
      |     |---------|     |-----|     |---------|     |-----------|
      ----->|  Alias  |---->|IMDCT|---->|Frequency|---->|Synthesis  |------>  Left PCM
            |reduction|     |-----|     |inversion|     |Filter bank|         channel
            |---------|                 |---------|     |-----------|
```
 preprocessing：主要完成Header和side information的解码。

 Huffman decoding：选择Huffman table，进行解码。

 Requantization：逆量化，短块和长块使用不同的公式。公式如下：

 短块：
```
  xri = sign(isi)*|isi|^(4/3)*2^(1/4(global_gain[gr]-210-8*subblock_gain[window][gr]))
     *2^-(scalefac_multiplier*scalefac_s[gr][ch][sfb][window])
```
 长块：
```
  xri = sign(isi)*|isi|^(4/3)*2^(1/4(global_gain[gr]-210)
     *2^-(scalefac_multiplier*(scalefac_l[sfb][ch][gr]+preflag[gr]*pretab[sfb]))
```
 Reodering：由于编码时对短块和混合块中的短块进行了重排，具体见编码部分，故解码时需要重新排序

 Stero decoding：立体声解码。

 Alias reduction：长块间需要消除混跌。

 IMDCT：每做一次MDCT产生36个输出。
  做完IMDCT后，需再做加窗运算。
  IMDCT做完后，再无长块、短块概念，得到的结果是从低到高的32个子带，每个子带18个值。

 子带合成滤波：
  先是把32个子带中，每个子带取一个数据，组成的32个值送入一个1024的FIFO中；
  接着把这1024个值中取出一半，对其做加窗运算，加窗系数由MP3官方协议的表格提供；
  最后对加窗结果进行叠加得到32个时域PCM输出。
```
                   BEGIN
                     |
      |--------------v--------------|
      | Input 32 New Subband Samples|
      |   Si  i = 0 ... 31          |
      |-----------------------------|
                     |
      |--------------v--------------|
      |     Shifting                |
      |  for i = 1023 downto 64 do  |
      |    V[i] = V[i - 64]         |
      |-----------------------------|
                     |
      |--------------v--------------|
      |      Matrixing              |
      | for i=0 to 63 do            |
      |  Vi=(N0*S0 + ... N31*S31)   |
      |-----------------------------|
                     |
      |--------------v--------------|
      | Build a 512 values vector U |
      |for i=0 to 7 do              |
      | for j=0 to 31 do            |
      |  U[i*64+j]=V[i*128+j]       |
      |  U[i*64+32+j]=V[i*128+96+j] |
      |-----------------------------|
                     |
      |--------------v--------------|
      | Window by 512 coefficients  |
      |    produce vector W         |
      | for i=0 to 511 do Wi=Ui*Di  |
      |-----------------------------|
                     |
      |--------------v--------------|
      |   Calculate 32 Samples      |
      |  for j=0 to 31 do           |
      |   Sj=(W[j] +                | 
      |    W[j+32]                  |
      |    .... +                   |
      |    W[j+32*15])              |
      |-----------------------------|
                     |
      |--------------v--------------|
      |  Output 32 reconstructed    |
      |     PCM Samples             |
      |-----------------------------|
                     |
                     v
                    END
```
# 4 附录

 ID3 V2官网：http://www.id3.org/id3v2.3.0

 APE V2官网：http://wiki.hydrogenaudio.org/index.php?title=APEv2_specification

 ISO/IEC 11172-3、ISO/IEC 13818-3

以上转载http://blog.csdn.net/evanwu_85/article/details/5761996,增加部分修改。

